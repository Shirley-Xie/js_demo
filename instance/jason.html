<!DOCTYPE html>
<html>
<head>
    <title>液位测试</title>
</head>
<body>
    <script type="text/javascript">
        var scontainerTable = '{"tank":{"name":"T102","fullVolume":5266.911,"deadVolume":5.927,"bottomVolume":23.476,"unsure":0.1,"a":0.000012,"refHeight":17439},"dm":[{"depth":0.66,"volume":23576},{"depth":1,"volume":34255},{"depth":2,"volume":65662},{"depth":3,"volume":97070},{"depth":4,"volume":128477},{"depth":4.4,"volume":141040},{"depth":5,"volume":159898},{"depth":6,"volume":191329},{"depth":7,"volume":222759},{"depth":8,"volume":254190},{"depth":9,"volume":285620},{"depth":10,"volume":317051},{"depth":10.5,"volume":332766},{"depth":11,"volume":348470},{"depth":12,"volume":379877},{"depth":13,"volume":411285},{"depth":14,"volume":442693},{"depth":15,"volume":474100},{"depth":16,"volume":505508},{"depth":17,"volume":536915},{"depth":18,"volume":568323},{"depth":19,"volume":599731},{"depth":19.19,"volume":605698},{"depth":20,"volume":631106},{"depth":21,"volume":662473},{"depth":22,"volume":693840},{"depth":23,"volume":725208},{"depth":24,"volume":756575},{"depth":25,"volume":787942},{"depth":26,"volume":819309},{"depth":27,"volume":850677},{"depth":28,"volume":882044},{"depth":29,"volume":913411},{"depth":30,"volume":944779},{"depth":31,"volume":976146},{"depth":32,"volume":1007513},{"depth":33,"volume":1038881},{"depth":34,"volume":1070248},{"depth":35,"volume":1101615},{"depth":36,"volume":1132983},{"depth":37,"volume":1164350},{"depth":38,"volume":1195717},{"depth":38.99,"volume":1226771},{"depth":39,"volume":1227085},{"depth":40,"volume":1258457},{"depth":41,"volume":1289829},{"depth":42,"volume":1321201},{"depth":43,"volume":1352573},{"depth":44,"volume":1383945},{"depth":45,"volume":1415317},{"depth":46,"volume":1446689},{"depth":47,"volume":1478061},{"depth":48,"volume":1509433},{"depth":49,"volume":1540805},{"depth":50,"volume":1572177},{"depth":51,"volume":1603550},{"depth":52,"volume":1634922},{"depth":53,"volume":1666294},{"depth":54,"volume":1697666},{"depth":55,"volume":1729038},{"depth":56,"volume":1760410},{"depth":57,"volume":1791782},{"depth":58,"volume":1823154},{"depth":58.79,"volume":1847938},{"depth":59,"volume":1854528},{"depth":60,"volume":1885906},{"depth":61,"volume":1917285},{"depth":62,"volume":1948663},{"depth":63,"volume":1980042},{"depth":64,"volume":2011421},{"depth":65,"volume":2042799},{"depth":66,"volume":2074178},{"depth":67,"volume":2105557},{"depth":68,"volume":2136935},{"depth":69,"volume":2168314},{"depth":70,"volume":2199693},{"depth":71,"volume":2231071},{"depth":72,"volume":2262450},{"depth":73,"volume":2293828},{"depth":74,"volume":2325207},{"depth":75,"volume":2356586},{"depth":76,"volume":2387964},{"depth":77,"volume":2419343},{"depth":78,"volume":2450722},{"depth":78.59,"volume":2469235},{"depth":79,"volume":2482097},{"depth":80,"volume":2513469},{"depth":81,"volume":2544840},{"depth":82,"volume":2576212},{"depth":83,"volume":2607583},{"depth":84,"volume":2638954},{"depth":85,"volume":2670326},{"depth":86,"volume":2701697},{"depth":87,"volume":2733069},{"depth":88,"volume":2764440},{"depth":89,"volume":2795811},{"depth":90,"volume":2827183},{"depth":91,"volume":2858554},{"depth":92,"volume":2889926},{"depth":93,"volume":2921297},{"depth":94,"volume":2952668},{"depth":95,"volume":2984040},{"depth":96,"volume":3015411},{"depth":97,"volume":3046783},{"depth":98,"volume":3078154},{"depth":98.39,"volume":3090389},{"depth":99,"volume":3109526},{"depth":100,"volume":3140898},{"depth":101,"volume":3172270},{"depth":102,"volume":3203642},{"depth":103,"volume":3235014},{"depth":104,"volume":3266386},{"depth":105,"volume":3297758},{"depth":106,"volume":3329130},{"depth":107,"volume":3360502},{"depth":108,"volume":3391874},{"depth":109,"volume":3423246},{"depth":110,"volume":3454618},{"depth":111,"volume":3485990},{"depth":112,"volume":3517362},{"depth":113,"volume":3548734},{"depth":114,"volume":3580106},{"depth":115,"volume":3611478},{"depth":116,"volume":3642850},{"depth":117,"volume":3674222},{"depth":118,"volume":3705594},{"depth":118.19,"volume":3711555},{"depth":119,"volume":3736957},{"depth":120,"volume":3768317},{"depth":121,"volume":3799678},{"depth":122,"volume":3831038},{"depth":123,"volume":3862399},{"depth":124,"volume":3893759},{"depth":125,"volume":3925120},{"depth":126,"volume":3956480},{"depth":127,"volume":3987841},{"depth":128,"volume":4019201},{"depth":129,"volume":4050562},{"depth":130,"volume":4081922},{"depth":131,"volume":4113282},{"depth":132,"volume":4144643},{"depth":133,"volume":4176003},{"depth":134,"volume":4207364},{"depth":135,"volume":4238724},{"depth":136,"volume":4270085},{"depth":137,"volume":4301445},{"depth":137.99,"volume":4332492},{"depth":138,"volume":4332806},{"depth":139,"volume":4364162},{"depth":140,"volume":4395518},{"depth":141,"volume":4426875},{"depth":142,"volume":4458231},{"depth":143,"volume":4489587},{"depth":144,"volume":4520944},{"depth":145,"volume":4552300},{"depth":146,"volume":4583656},{"depth":147,"volume":4615013},{"depth":148,"volume":4646369},{"depth":149,"volume":4677726},{"depth":150,"volume":4709082},{"depth":151,"volume":4740438},{"depth":152,"volume":4771795},{"depth":153,"volume":4803151},{"depth":154,"volume":4834507},{"depth":155,"volume":4865864},{"depth":156,"volume":4897220},{"depth":157,"volume":4928576},{"depth":157.79,"volume":4953348},{"depth":158,"volume":4959933},{"depth":159,"volume":4991289},{"depth":160,"volume":5022645},{"depth":161,"volume":5054002},{"depth":162,"volume":5085358},{"depth":163,"volume":5116714},{"depth":164,"volume":5148071},{"depth":165,"volume":5179427},{"depth":166,"volume":5210783},{"depth":167,"volume":5242140},{"depth":167.79,"volume":5266911}],"cm":[{"begin":0.66,"end":4.4,"cm":{"1":3141,"2":6281,"3":9422,"4":12563,"5":15704,"6":18844,"7":21985,"8":25126,"9":28267},"mm":{"1":314,"2":628,"3":942,"4":1256,"5":1570,"6":1884,"7":2199,"8":2513,"9":2827}},{"begin":4.4,"end":10.5,"cm":{"1":3143,"2":6286,"3":9429,"4":12572,"5":15715,"6":18858,"7":22001,"8":25144,"9":28287},"mm":{"1":314,"2":629,"3":943,"4":1257,"5":1572,"6":1886,"7":2200,"8":2514,"9":2829}},{"begin":10.5,"end":19.19,"cm":{"1":3141,"2":6282,"3":9422,"4":12563,"5":15704,"6":18845,"7":21985,"8":25126,"9":28267},"mm":{"1":314,"2":628,"3":942,"4":1256,"5":1570,"6":1884,"7":2199,"8":2513,"9":2827}},{"begin":19.19,"end":38.99,"cm":{"1":3137,"2":6273,"3":9410,"4":12547,"5":15684,"6":18820,"7":21957,"8":25094,"9":28231},"mm":{"1":314,"2":627,"3":941,"4":1255,"5":1568,"6":1882,"7":2196,"8":2509,"9":2823}},{"begin":38.99,"end":58.79,"cm":{"1":3137,"2":6274,"3":9412,"4":12549,"5":15686,"6":18823,"7":21960,"8":25098,"9":28235},"mm":{"1":314,"2":627,"3":941,"4":1255,"5":1569,"6":1882,"7":2196,"8":2510,"9":2823}},{"begin":58.79,"end":78.59,"cm":{"1":3138,"2":6276,"3":9414,"4":12551,"5":15689,"6":18827,"7":21965,"8":25103,"9":28241},"mm":{"1":314,"2":628,"3":941,"4":1255,"5":1569,"6":1883,"7":2197,"8":2510,"9":2824}},{"begin":78.59,"end":98.39,"cm":{"1":3137,"2":6274,"3":9411,"4":12549,"5":15686,"6":18823,"7":21960,"8":25097,"9":28234},"mm":{"1":314,"2":627,"3":941,"4":1255,"5":1569,"6":1882,"7":2196,"8":2510,"9":2823}},{"begin":98.39,"end":118.19,"cm":{"1":3137,"2":6274,"3":9412,"4":12549,"5":15686,"6":18823,"7":21960,"8":25098,"9":28235},"mm":{"1":314,"2":627,"3":941,"4":1255,"5":1569,"6":1882,"7":2196,"8":2510,"9":2823}},{"begin":118.19,"end":137.99,"cm":{"1":3136,"2":6272,"3":9408,"4":12544,"5":15680,"6":18816,"7":21952,"8":25088,"9":28224},"mm":{"1":314,"2":627,"3":941,"4":1254,"5":1568,"6":1882,"7":2195,"8":2509,"9":2822}},{"begin":137.99,"end":157.79,"cm":{"1":3136,"2":6271,"3":9407,"4":12543,"5":15678,"6":18814,"7":21949,"8":25085,"9":28221},"mm":{"1":314,"2":627,"3":941,"4":1254,"5":1568,"6":1881,"7":2195,"8":2509,"9":2822}},{"begin":157.79,"end":167.79,"cm":{"1":3136,"2":6271,"3":9407,"4":12543,"5":15678,"6":18814,"7":21949,"8":25085,"9":28221},"mm":{"1":314,"2":627,"3":941,"4":1254,"5":1568,"6":1881,"7":2195,"8":2509,"9":2822}}],"stablePresure":[[0,0,1,1,2,4,5,7,10,12],[15,18,22,26,30,34,39,44,49,55],[61,67,74,81,88,95,103,111,119,128],[137,146,156,166,176,187,198,209,220,232],[244,256,269,282,295,309,322,337,351,366],[381,396,412,428,444,461,478,495,513,531],[549,567,586,605,624,644,664,684,705,726],[747,768,790,812,835,857,880,904,927,951],[975,1000,1025,1050,1075,1101,1127,1154,1180,1207],[1234,1262,1290,1318,1347,1375,1405,1434,1464,1494],[1524,1555,1586,1617,1648,1680,1712,1745,1778,1811],[1844,1878,1912,1946,1981,2016,2051,2086,2122,2158],[2195,2231,2268,2306,2343,2381,2420,2458,2497,2536],[2576,2615,2655,2696,2737,2778,2819,2860,2902,2945],[2987,3030,3073,3116,3160,3204,3249,3293,3338,3383],[3429,3475,3521,3568,3614,3661,3709,3757,3805,3853],[3902,3950,4000,4049,4099,4149,4200,4250]],"bottom":[[5927,6111,6295,6479,6669,6859,7048,7238,7448,7662],[7876,8090,8305,8524,8755,8992,9228,9469,9711,9958],[10205,10457,10710,10968,11236,11504,11773,12041,12315,12589],[12863,13143,13427,13718,14008,14298,14589,14879,15169,15460],[15750,16051,16352,16653,16954,17255,17556,17857,18158,18459],[18760,19061,19362,19663,19964,20265,20566,20867,21168,21469],[21770,22071,22372,22673,22974,23275,23576]]}';

  function findCMList(capcityTable, levelValue) {
    capcityTable.cm = JSON.parse(capcityTable.cm);
    var cmRecords = capcityTable.cm;
    for (var i = 0; i < cmRecords.length; i++){
      var cmList = capcityTable.cm[i];
      var begin = cmList.begin * 100;
      var end = cmList.end * 100;
  
      if (levelValue >= begin && levelValue < end) { 
        return cmList;
      }
    }

    return null;
  }

function calcVB(capcityTable, levelValue){
  capcityTable.dm = JSON.parse(capcityTable.dm);
    //dm
    var lastRecord = null;
    var volume = 0;
    var dmRecords = capcityTable.dm;
    var cmLevelValue = null;
    var mmLevelValue = null;

    for (var i = 0; i < dmRecords.length; i++){
      var dmRecord = dmRecords[i];
      dmRecord.depth = parseInt(dmRecord.depth * 100);

      if (levelValue < dmRecord.depth) {
        cmLevelValue = levelValue - lastRecord.depth;
        mmLevelValue = cmLevelValue % 10;
        cmLevelValue = (cmLevelValue - mmLevelValue) / 10;

        volume += lastRecord.volume;
        break;
      }

      lastRecord = dmRecord;
    }

    //cm和mm
    // 查找level对应的厘米毫米表
    var cmRange = findCMList(capcityTable, levelValue);
    if(null == cmRange)
    {
      throw new Error('液位' + levelValue + '超范围！');
    }

    if(cmLevelValue > 0)
    {
      volume += cmRange.cm[cmLevelValue];
    }
    
    if(mmLevelValue > 0)
    {
      volume += cmRange.mm[mmLevelValue];
    }

    return volume;
}

function calcVs (capcityTable, levelValue) {
  //先取出整张表的信息
  var presureTable = capcityTable.stablePresure;
  var levelValueM = Math.floor((levelValue) / 1000);
  var levelValueDM = (levelValue - (levelValue % 100)-levelValueM*1000);
  
  levelValueDM /= 100;

  dmTable = presureTable[levelValueM];
  if(!dmTable)
  {
    throw new Error("静压力容量修正表无法查找到" + levelValue + "记录！");
  }

  return dmTable[levelValueDM];
}

function bottom (capcityTable, levelValue) {
  //取出底量参考容量表
  var bottomTable = capcityTable.bottom;
  var levelValueMM = levelValue % 10;
  var levelValueCM = (levelValue - levelValueMM)/10;

  mmTable = bottomTable[levelValueCM];
  if(!mmTable)
  {
   throw new Error("底量容量表无法查找到" + levelValue + "记录！"); 
  }
  return mmTable[levelValueMM];
}
//计算检空尺对应的容量
function calcVolume (capcityTable, levelValue, density, ty, tq) {
  capcityTable = JSON.parse(capcityTable);
  var Vb,Vs;   
  if(levelValue > 66){
     Vb = calcVB(capcityTable, levelValue);
     Vs = calcVs(capcityTable, levelValue);
  }else{
     Vb = bottom(capcityTable, levelValue);
     Vs = 0;
  }
  
  var a = 0.000012;

  var t = (7 * ty + tq) / 8;
  var Vp = Vs * density;
  var Vt = (Vb + Vp) * (1 + 2 * a * (t - 20));
  return Vt;
}

console.log(calcVolume (scontainerTable, 75, 0.9587731903539869, 29.908512057516347, 66.3));



</script>

</body>
</html>

